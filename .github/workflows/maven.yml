name: Build the updater

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  id-token: write
  contents: read
jobs:
  build_windows:
    runs-on: windows-latest
    steps:
      - name: 📩 Set up JDK 11
        uses: actions/checkout@v3

      - name: 🏗️ Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: temurin
          cache: maven

      - name: 🔨 Compile the updater
        run: bash build.sh compile

      - name: 📦 Build the Windows artifact
        run: bash build.sh dist-windows

      - name: 🔨 Create installer
        uses: joncloud/makensis-action@v4.1
        with:
          script-file: "Installer.nsi"
          
      - name: 🔐 Azure login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ✍️ Sign files with Trusted Signing
        uses: azure/trusted-signing-action@v0.5.0
        with:
          # azure-username: ${{ secrets.AZURE_USERNAME }}
          # azure-password: ${{ secrets.AZURE_PASSWORD }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          endpoint: https://eus.codesigning.azure.net/
          trusted-signing-account-name: vscx-codesigning
          certificate-profile-name: vscx-certificate-profile
          files-folder: dist/Casterlabs-Caffeinated-Setup.exe
          file-digest: SHA256
          timestamp-rfc3161: http://timestamp.acs.microsoft.com
          timestamp-digest: SHA256
          exclude-environment-credential: true
          exclude-workload-identity-credential: true
          exclude-managed-identity-credential: true
          exclude-shared-token-cache-credential: true
          exclude-visual-studio-credential: true
          exclude-visual-studio-code-credential: true
          exclude-azure-cli-credential: false
          exclude-azure-powershell-credential: true
          exclude-azure-developer-cli-credential: true
          exclude-interactive-browser-credential: true

      - name: 🆙 Upload the Windows artifact (x86_64)
        uses: actions/upload-artifact@v3
        with:
          name: Casterlabs-Caffeinated-windows-x86_64.zip
          path: dist/artifacts/Casterlabs-Caffeinated-windows-x86_64.zip
      
      - name: 🆙 Upload the Windows installer (x86_64)
        uses: actions/upload-artifact@v3
        with:
          name: Casterlabs-Caffeinated-Setup.exe
          path: dist/Casterlabs-Caffeinated-Setup.exe
      
  build_macos:
    runs-on: ubuntu-latest
    steps:
      - name: 📩 Set up JDK 11
        uses: actions/checkout@v3

      - name: 🏗️ Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: temurin
          cache: maven

      - name: 🔨 Compile the updater
        run: bash build.sh compile

      - name: 📦 Build the macOS artifact
        run: bash build.sh dist-macos

      - name: 🆙 Upload the macOS artifact (aarch64)
        uses: actions/upload-artifact@v3
        with:
          name: Casterlabs-Caffeinated-macos-aarch64.tar.gz
          path: dist/artifacts/Casterlabs-Caffeinated-macos-aarch64.tar.gz

      - name: 🆙 Upload the macOS artifact (x86_64)
        uses: actions/upload-artifact@v3
        with:
          name: Casterlabs-Caffeinated-macos-x86_64.tar.gz
          path: dist/artifacts/Casterlabs-Caffeinated-macos-x86_64.tar.gz

  build_linux:
    runs-on: ubuntu-latest
    steps:
      - name: 📩 Set up JDK 11
        uses: actions/checkout@v3

      - name: 🏗️ Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: 11
          distribution: temurin
          cache: maven

      - name: 🔨 Compile the updater
        run: bash build.sh compile

      - name: 📦 Build the Linux artifact
        run: bash build.sh dist-linux

      - name: 🆙 Upload the Linux artifact (aarch64)
        uses: actions/upload-artifact@v3
        with:
          name: Casterlabs-Caffeinated-gnulinux-aarch64.tar.gz
          path: dist/artifacts/Casterlabs-Caffeinated-gnulinux-aarch64.tar.gz

      - name: 🆙 Upload the Linux artifact (arm)
        uses: actions/upload-artifact@v3
        with:
          name: Casterlabs-Caffeinated-gnulinux-arm.tar.gz
          path: dist/artifacts/Casterlabs-Caffeinated-gnulinux-arm.tar.gz

      - name: 🆙 Upload the Linux artifact (x86_64)
        uses: actions/upload-artifact@v3
        with:
          name: Casterlabs-Caffeinated-gnulinux-x86_64.tar.gz
          path: dist/artifacts/Casterlabs-Caffeinated-gnulinux-x86_64.tar.gz
